name: Deploy to My Local Server

on:
  workflow_dispatch: # workflow_dispatch 表示这个工作流可以手动触发。
  push:
    branches: ['main']


# SSH_PRIVATE_KEY: 本地服务器的私钥
# SSH_USER: 本地服务器的用户名
# SSH_HOST: 本地服务器的 IP 或主机名
# SSH_PORT: 本地服务器的端口（通常是 22）
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: 查看密钥~
        run: |
          echo "${{secrets.SSH_PRIVATE_KEY}}"
          echo "${{secrets.SSH_USER}}"
          echo "${{secrets.SSH_HOST}}"
          echo "${{secrets.SSH_PORT}}"
          ls -al


      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          echo -e "Host root\nHostName 47.108.70.190\nUser root\nPort 22" > ~/.ssh/config

      - name: 安装依赖 && 打包文件
        run: |
          # 在这里添加你的打包命令
          echo "下载依赖...."
          # npm install
          echo "打包文件"
          # npm run build
          echo "显示文件"
          ls -al

      # - name: Compress build files
      #   run: |
      #     tar -czvf build.tar.gz -C src .

      - name: 查看目录结构
        run:
          ls -al

      - name: 使用 scp 下载文件
        run: |
          echo "查看线上的文件"
          ssh root "ls /root/affine-pro-build-result -al"
          echo "查看下载的文件"
          mkdir my-test123
          scp -r root:/root/affine-pro-build-result ./my-test123
          ls ./my-test123 -al

      - name: 使用 scp 下载文件2
        run: |
          mkdir my-result
          ls -al
          scp -r root:/root/affine-pro-build-result ./my-result
          echo "查看下载的文件"
          ls ./my-result -al

      # - name: Transfer files via SCP
      #   run: |
      #     scp -P ${{ secrets.SSH_PORT }} build.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/root/affine-pro-build-result

      - name: Clean up
        run: |
          rm build.tar.gz
